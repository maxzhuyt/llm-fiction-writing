{% extends "base.html" %}

{% block title %}Story Engine{% endblock %}

{% block nav_links %}
<a href="/" class="sidebar-nav-btn active">Story Engine</a>
<a href="/ideas" class="sidebar-nav-btn">Idea Generator</a>
<a href="/sessions" class="sidebar-nav-btn">Sessions</a>
{% endblock %}

{% block variables_help %}
<details class="help-section">
    <summary>How to use variables</summary>
    <p>Reference previous outputs in your prompts:</p>
    <p>Type <code>step0_output</code>, <code>step1_output</code>, etc. directly in any User Prompt field.</p>
    <p>The system will automatically replace these with the actual generated content when sending to the LLM.</p>
</details>
{% endblock %}

{% block content %}
<h1>Story Engine</h1>

<div id="api-key-warning" class="warning" style="display: none;">
    Enter an OpenRouter API key in the sidebar to enable generation.
</div>

<!-- Steps Container -->
<div class="steps-container">
    {% for step in steps %}
    <section class="step-section" data-step="{{ step.num }}">
        <h2>Step {{ step.num }}: {{ step.title }}</h2>

        <!-- System Prompt -->
        <div class="prompt-section">
            <label>System Prompt</label>
            <div class="editor-container">
                <div class="editor-wrapper">
                    <textarea id="step{{ step.num }}-system" class="code-editor" data-field="system">{{ step.default_system }}</textarea>
                </div>
                <div class="editor-buttons">
                    <button class="btn btn-small edit-toggle-btn" data-editor="step{{ step.num }}-system" data-editing="true">Done</button>
                    <button class="btn btn-small editor-copy-btn" data-editor="step{{ step.num }}-system" title="Copy to clipboard">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- User Prompt -->
        <div class="prompt-section">
            <label>User Prompt</label>
            <div class="editor-container">
                <div class="editor-wrapper">
                    <textarea id="step{{ step.num }}-user" class="code-editor" data-field="user">{{ step.default_user }}</textarea>
                </div>
                <div class="editor-buttons">
                    <button class="btn btn-small edit-toggle-btn" data-editor="step{{ step.num }}-user" data-editing="true">Done</button>
                    <button class="btn btn-small editor-copy-btn" data-editor="step{{ step.num }}-user" title="Copy to clipboard">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="step{{ step.num }}-variables" class="variables-status"></div>
        </div>

        <!-- Include Previous Checkbox (for steps > 0) -->
        {% if step.num > 0 %}
        <label class="checkbox-label">
            <input type="checkbox" id="step{{ step.num }}-include-prev">
            {% if step.num == 1 %}
            Build on Step 0
            {% else %}
            Build on previous steps
            {% endif %}
        </label>
        {% endif %}

        <!-- Buttons -->
        <div class="button-row">
            <button class="btn btn-primary generate-btn" data-step="{{ step.num }}">
                {{ step.button_label }}
            </button>
            <button class="btn btn-secondary export-btn" data-step="{{ step.num }}">
                Export Prompts
            </button>
        </div>

        <!-- Output -->
        <div class="output-section" id="step{{ step.num }}-output-section" style="display: none;">
            <label>Output</label>
            <div class="output-wrapper">
                <div id="step{{ step.num }}-output" class="output-display"></div>
                <button class="copy-btn" data-step="{{ step.num }}" title="Copy to clipboard">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                </button>
            </div>
        </div>

        <hr class="step-divider">
    </section>
    {% endfor %}
</div>

<!-- Export Session Button -->
<div id="save-session-container" class="session-actions" style="display: none;">
    <button id="export-full-session-btn" class="btn btn-primary">Export Full Session</button>
</div>

<!-- Evaluation Panel -->
<section class="evaluation-panel">
    <details>
        <summary><h2>Evaluate Text with LLM</h2></summary>

        <div class="eval-content">
            <!-- Model selection for evaluation -->
            <div class="eval-model-section">
                <label>Model for evaluation</label>
                <select id="eval-model-select">
                    {% for name, id in models.items() %}
                    <option value="{{ id }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- System Prompt -->
            <div class="prompt-section">
                <label>System Prompt</label>
                <div class="editor-container">
                    <div class="editor-wrapper">
                        <textarea id="eval-system" class="code-editor">Evaluate stories.</textarea>
                    </div>
                    <div class="editor-buttons">
                        <button class="btn btn-small edit-toggle-btn" data-editor="eval-system" data-editing="true">Done</button>
                        <button class="btn btn-small editor-copy-btn" data-editor="eval-system" title="Copy to clipboard">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Prompt (supports variables) -->
            <div class="prompt-section">
                <label>User Prompt <span class="hint">(use step0_output, step1_output, step2_output to insert generated content)</span></label>
                <div class="editor-container">
                    <div class="editor-wrapper">
                        <textarea id="eval-user" class="code-editor">Read the following story and provide your evaluation:

step2_output</textarea>
                    </div>
                    <div class="editor-buttons">
                        <button class="btn btn-small edit-toggle-btn" data-editor="eval-user" data-editing="true">Done</button>
                        <button class="btn btn-small editor-copy-btn" data-editor="eval-user" title="Copy to clipboard">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="eval-variables" class="variables-status"></div>
            </div>

            <!-- Buttons -->
            <div class="button-row">
                <button id="eval-btn" class="btn btn-primary">Evaluate</button>
                <button id="eval-clear-btn" class="btn btn-secondary">Clear History</button>
            </div>

            <!-- Evaluation History -->
            <div id="eval-history"></div>
        </div>
    </details>
</section>
{% endblock %}

{% block page_scripts %}
<script src="/static/js/app.js"></script>
{% endblock %}

{% block extra_config %}
steps: {{ steps | tojson | safe }}
{% endblock %}
